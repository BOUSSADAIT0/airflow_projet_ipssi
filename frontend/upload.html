<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload - OCR Intelligent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-file-alt text-white text-xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-900">OCR Intelligent</h1>
                </div>
                <div class="flex items-center gap-4">
                    <a href="history.html"
                        class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                        <i class="fas fa-history mr-2"></i>Historique
                    </a>
                    <span id="usernameDisplay" class="text-gray-700 font-medium"></span>
                    <button onclick="logout()"
                        class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">
                        <i class="fas fa-sign-out-alt mr-2"></i>Déconnexion
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-5xl mx-auto px-4 py-8">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900">Télécharger un document</h2>
            <p class="mt-2 text-gray-600">Formats support és : PDF, JPG, PNG, TIFF, .pages</p>
        </div>

        <!-- Upload Zone -->
        <div class="bg-white rounded-xl shadow-sm p-8 mb-6">
            <div id="dropZone"
                class="border-2 border-dashed border-blue-300 rounded-xl p-12 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition">
                <input type="file" id="fileInput" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.tiff,.tif,.pages">
                <i class="fas fa-cloud-upload-alt text-5xl text-blue-500 mb-4"></i>
                <p class="text-xl font-semibold text-gray-700 mb-2">Glissez-déposez votre fichier</p>
                <p class="text-gray-600">ou cliquez pour sélectionner</p>
                <p class="text-sm text-gray-500 mt-4">PDF, JPG, PNG, TIFF, .pages - max 10MB</p>
            </div>

            <div id="fileInfo" class="hidden mt-6 p-4 bg-blue-50 rounded-lg">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-medium" id="fileName"></p>
                        <p class="text-sm text-gray-600" id="fileSize"></p>
                    </div>
                    <button onclick="removeFile()" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Options -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Langue</label>
                    <select id="languageSelect" class="w-full border border-gray-300 rounded-lg p-2">
                        <option value="fra+eng">Français + Anglais</option>
                        <option value="fra">Français</option>
                        <option value="eng">Anglais</option>
                    </select>
                </div>
            </div>

            <!-- Buttons -->
            <div class="mt-6 flex gap-4">
                <button onclick="clearFile()"
                    class="flex-1 border border-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-50">
                    <i class="fas fa-trash mr-2"></i>Effacer
                </button>
                <button id="processBtn" onclick="processDocument()" disabled
                    class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-bolt mr-2"></i>Traiter le document
                </button>
            </div>
        </div>

        <!-- Processing -->
        <div id="loadingSection" class="hidden bg-white rounded-xl shadow-sm p-8 text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
            <p class="text-gray-600">Traitement en cours...</p>
        </div>

        <!-- Results -->
        <div id="resultsSection" class="hidden bg-white rounded-xl shadow-sm p-8">
            <h3 class="text-2xl font-bold mb-6"><i class="fas fa-chart-bar mr-2 text-blue-600"></i>Résultats</h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Type de document</p>
                    <p class="text-lg font-bold capitalize" id="resDocType"></p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Confiance OCR</p>
                    <p class="text-lg font-bold" id="resConfidence"></p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Pages</p>
                    <p class="text-lg font-bold" id="resPages"></p>
                </div>
            </div>

            <div id="structuredDataContainer" class="mb-6 border rounded-lg p-4">
                <h4 class="font-bold mb-3 text-blue-700"><i class="fas fa-database mr-2"></i>Données structurées</h4>
                <div id="structuredData"></div>
            </div>

            <div class="border rounded-lg p-4">
                <h4 class="font-bold mb-3 text-gray-700"><i class="fas fa-file-alt mr-2"></i>Texte extrait</h4>
                <div class="bg-gray-50 p-4 rounded max-h-96 overflow-y-auto">
                    <pre id="rawText" class="text-sm whitespace-pre-wrap"></pre>
                </div>
            </div>

            <div class="mt-6 flex gap-4">
                <button onclick="downloadResult('json')"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                    <i class="fas fa-download mr-2"></i>Télécharger JSON
                </button>
                <button onclick="downloadResult('csv')"
                    class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                    <i class="fas fa-file-csv mr-2"></i>Télécharger CSV
                </button>
                <button onclick="resetUI()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-redo mr-2"></i>Nouveau document
                </button>
            </div>
        </div>

        <div id="errorSection" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 text-red-800"></div>
    </main>

    <script>
        const API_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') ? 'http://localhost:8000/api' : ('http://' + window.location.hostname + ':8000/api');
        let authToken = localStorage.getItem('ocr_token');
        let currentFile = null;
        let currentProcessId = null;

        // Check auth on load
        if (!authToken) {
            window.location.href = 'login.html';
        }

        // Display username
        document.getElementById('usernameDisplay').textContent = localStorage.getItem('ocr_user') || 'Utilisateur';

        // Drag and drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
        });

        dropZone.addEventListener('drop', (e) => handleFile(e.dataTransfer.files[0]));

        async function handleFile(file) {
            if (!file) return;

            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                showError('Fichier trop volumineux (max 10MB)');
                return;
            }

            currentFile = file;
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('processBtn').disabled = true;

            // Envoi direct au backend dès la sélection (sans cliquer sur "Traiter le document")
            await processDocument();
            document.getElementById('processBtn').disabled = false;
        }

        function removeFile() {
            currentFile = null;
            fileInput.value = '';
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('processBtn').disabled = true;
        }

        function clearFile() {
            removeFile();
        }

        async function processDocument() {
            if (!currentFile) return;

            // Vérifier le token avant d'envoyer (évite 401)
            let token = localStorage.getItem('ocr_token');
            if (!token) {
                showError('Session expirée. Redirection vers la connexion...');
                setTimeout(() => { window.location.href = 'login.html'; }, 1500);
                return;
            }

            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');

            const formData = new FormData();
            formData.append('file', currentFile);
            formData.append('language', document.getElementById('languageSelect').value);

            try {
                const response = await fetch(`${API_URL}/ocr/extract`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (response.status === 401) {
                    showError('Session expirée (401). Reconnectez-vous.');
                    localStorage.removeItem('ocr_token');
                    localStorage.removeItem('ocr_user');
                    setTimeout(() => { window.location.href = 'login.html'; }, 2000);
                    return;
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erreur de traitement');
                }

                const result = await response.json();
                currentProcessId = result.process_id;
                displayResults(result);

            } catch (error) {
                showError(error.message);
            } finally {
                document.getElementById('loadingSection').classList.add('hidden');
            }
        }

        function displayResults(data) {
            document.getElementById('resultsSection').classList.remove('hidden');

            document.getElementById('resDocType').textContent = data.document_type || 'Inconnu';
            document.getElementById('resConfidence').textContent = `${(data.average_confidence * 100).toFixed(1)}%`;
            document.getElementById('resPages').textContent = data.total_pages;
            document.getElementById('rawText').textContent = data.text || 'Aucun texte extrait';

            // Display structured data
            const structuredData = data.structured_data || {};
            const container = document.getElementById('structuredData');
            container.innerHTML = '';

            if (Object.keys(structuredData).length === 0) {
                container.innerHTML = '<p class="text-gray-400 italic">Aucune donnée structurée</p>';
            } else {
                Object.entries(structuredData).forEach(([key, value]) => {
                    if (!value || (Array.isArray(value) && value.length === 0)) return;

                    const row = document.createElement('div');
                    row.className = 'flex border-b border-gray-200 py-2';
                    row.innerHTML = `
                        <div class="text-blue-600 font-medium w-1/3 capitalize">${key.replace(/_/g, ' ')}</div>
                        <div class="w-2/3 text-gray-700">${Array.isArray(value) ? value.join(', ') : value}</div>
                    `;
                    container.appendChild(row);
                });
            }
        }

        async function downloadResult(format) {
            if (!currentProcessId) return;

            try {
                const response = await fetch(`${API_URL}/ocr/download/${currentProcessId}/${format}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ocr_result_${currentProcessId}.${format}`;
                a.click();
            } catch (error) {
                showError('Erreur de téléchargement');
            }
        }

        function resetUI() {
            removeFile();
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('errorSection').classList.add('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorSection');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function logout() {
            localStorage.removeItem('ocr_token');
            localStorage.removeItem('ocr_user');
            window.location.href = 'login.html';
        }
    </script>
</body>

</html>