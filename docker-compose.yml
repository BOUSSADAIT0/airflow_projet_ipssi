x-airflow-common: &airflow-common
  image: apache/airflow:2.8.1
  env_file:
    - .env
  environment:
    AIRFLOW__CORE__EXECUTOR: LocalExecutor
    AIRFLOW__CORE__LOAD_EXAMPLES: "False"

    # ðŸ”¹ LOGS : hostname pour l'URL des logs (Ã©vite "Request URL is missing an 'http://' or 'https://' protocol")
    PYTHONPATH: /opt/airflow/project
    AIRFLOW__CORE__HOSTNAME_CALLABLE: airflow_hostname.get_hostname
    AIRFLOW__LOGGING__REMOTE_LOGGING: "False"
    AIRFLOW__WEBSERVER__EXPOSE_HOSTNAME: "True"
    AIRFLOW__WEBSERVER__BASE_URL: "http://localhost:8080"

    # ðŸ”¹ DB Airflow
    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow

  volumes:
    - ./dags:/opt/airflow/dags
    - ./logs:/opt/airflow/logs
    - ./data:/opt/airflow/data
    # Projet (invoice_processor, semantic_extractor, uploads) pour le DAG factures
    - .:/opt/airflow/project

  networks:
    - airflow-net

services:

  postgres:
    image: postgres:15
    container_name: postgres
    hostname: postgres
    environment:
      POSTGRES_USER: airflow
      POSTGRES_PASSWORD: airflow
      POSTGRES_DB: airflow
    volumes:
      - postgres-db:/var/lib/postgresql/data
    networks:
      - airflow-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U airflow"]
      interval: 5s
      retries: 5

  airflow-init:
    <<: *airflow-common
    container_name: airflow-init
    entrypoint: /bin/bash
    command:
      - -c
      - |
        function verifynotempty() {
          until PGPASSWORD=airflow psql -h postgres -U airflow -d airflow -c "select 1" > /dev/null 2>&1; do
            echo "Waiting for postgres..."
            sleep 1
          done
        }
        verifynotempty
        airflow db init
        airflow users create \
          --username admin \
          --firstname Admin \
          --lastname User \
          --role Admin \
          --email admin@example.com \
          --password admin || true
    depends_on:
      postgres:
        condition: service_healthy

  airflow-webserver:
    <<: *airflow-common
    image: airflow-invoices:2.8.1
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: airflow-webserver
    hostname: airflow-webserver
    command: webserver
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      airflow-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/health"]
      interval: 10s
      timeout: 10s
      retries: 5

  airflow-scheduler:
    <<: *airflow-common
    image: airflow-invoices:2.8.1
    container_name: airflow-scheduler
    hostname: airflow-scheduler
    command: scheduler
    ports:
      - "8793:8793"
    depends_on:
      postgres:
        condition: service_healthy
      airflow-init:
        condition: service_completed_successfully

  # ðŸ”¹ API utilisÃ©e par ton DAG
  mock-api:
    <<: *airflow-common
    container_name: mock-api
    hostname: mock-api
    command: >
      bash -c "python /opt/airflow/scripts/mock_api.py"
    ports:
      - "8099:8099"
    volumes:
      - ./scripts:/opt/airflow/scripts
      - ./data:/opt/airflow/data
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8099/health').read()"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ðŸ”¹ Application Web Flask pour l'extraction de factures
  invoice-web:
    image: python:3.11-slim
    container_name: invoice-web
    hostname: invoice-web
    working_dir: /app
    command: >
      bash -c "
      apt-get update -qq &&
      apt-get install -y -qq poppler-utils tesseract-ocr tesseract-ocr-fra tesseract-ocr-eng > /dev/null 2>&1 &&
      pip install --quiet flask werkzeug pillow requests openpyxl pytesseract pdf2image pymupdf &&
      python web_app.py
      "
    ports:
      - "5000:5000"
    volumes:
      - .:/app
      - ./uploads:/app/uploads
      - ./data:/app/data
    environment:
      - FLASK_ENV=development
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OLLAMA_BASE_URL=http://ollama:11434
    networks:
      - airflow-net
    depends_on:
      - postgres
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/api/status').read()"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

volumes:
  postgres-db:

networks:
  airflow-net:
